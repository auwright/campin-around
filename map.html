<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campin Around — Map</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root{
      --bg:#0f1724;
      --text:#e6eef8;
      --pin:#ffa500;     /* orange for tent icon */
      --cluster:#ffb347; /* cluster base */
      --cluster2:#ff9800;/* medium */
      --cluster3:#f57c00;/* large */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .topbar{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.12)}
    a{color:#7dd3fc;text-decoration:none}
    #map{height:calc(100% - 50px);}

    /* Popup theming */
    .leaflet-popup-content-wrapper{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,.08)}
    .leaflet-popup-tip{background:#0b1220;}

    /* Tent marker as a DivIcon with inline SVG */
    .tent-marker{
      position:relative;
      width:28px;height:28px; /* visual box; SVG scales to fit */
      transform: translateZ(0); /* crisper on some GPUs */
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.45));
    }
    .tent-marker svg{
      width:28px;height:28px;display:block;
    }
    .tent-fill{ fill: var(--pin); }
    .tent-stroke{ stroke: rgba(0,0,0,.75); stroke-width:1.5; fill:none; stroke-linejoin:round; }

    /* Cluster bubbles */
    .cluster{background:transparent;}
    .cluster .cluster-bubble{
      display:flex;align-items:center;gap:6px;justify-content:center;
      width:36px;height:36px;border-radius:999px;
      color:#111;font-weight:800;font-variant-numeric:tabular-nums;
      border:1px solid rgba(0,0,0,.45);
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.18);
      background:radial-gradient(ellipse at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 45%), var(--cluster);
    }
    .cluster.cluster-medium .cluster-bubble{
      background:radial-gradient(ellipse at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 45%), var(--cluster2);
      width:42px;height:42px;
    }
    .cluster.cluster-large .cluster-bubble{
      background:radial-gradient(ellipse at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 45%), var(--cluster3);
      width:48px;height:48px;
    }
    .cluster .tent-glyph{
      width:14px;height:14px; display:block;
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.25));
    }
    .cluster .tent-glyph .tent-fill{ fill:#6b3a00; } /* darker, for contrast on orange */
    .cluster .tent-glyph .tent-stroke{ stroke: rgba(0,0,0,.65); stroke-width:1.2; }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="index.html">← Back</a> &nbsp; | &nbsp; <strong>Map</strong>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Init map
    const map = L.map('map', { scrollWheelZoom: true }).setView([44.1, -121.7], 7);

    // Dark tiles (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // ---------- Custom TENT marker (DivIcon with inline SVG) ----------
    const tentSVG = `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- simple tent -->
        <path class="tent-fill" d="M4 18 L12 6 L20 18 Z"/>
        <path class="tent-stroke" d="M4 18 L12 6 L20 18 Z M12 6 V18" />
        <!-- door -->
        <path class="tent-stroke" d="M11 18 L12 13 L13 18" />
        <!-- small ground line for visual anchor -->
        <path class="tent-stroke" d="M3.5 18.5 H20.5" />
      </svg>
    `;

    const tentIcon = L.divIcon({
      className: 'tent-marker',
      html: tentSVG,
      iconSize: [28,28],
      iconAnchor: [14,20],   // bottom-center-ish; tweak if needed
      popupAnchor: [0,-16]
    });

    // ---------- Cluster layer with tent glyph ----------
    const clusters = L.markerClusterGroup({
      chunkedLoading: true,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      maxClusterRadius: 50,
      iconCreateFunction: (cluster) => {
        const count = cluster.getChildCount();
        const size =
          count >= 50 ? 'cluster-large' :
          count >= 10 ? 'cluster-medium' : 'cluster-small';

        const glyph = `
          <svg class="tent-glyph" viewBox="0 0 24 24" aria-hidden="true">
            <path class="tent-fill" d="M4 18 L12 6 L20 18 Z"/>
            <path class="tent-stroke" d="M4 18 L12 6 L20 18 Z M12 6 V18" />
          </svg>`;

        return L.divIcon({
          html: `<div class="cluster-bubble">${glyph}<span>${count}</span></div>`,
          className: `cluster ${size}`,
          iconSize: [48,48]
        });
      }
    });

    // ---------- Load your GeoJSON ----------
    fetch('camping_locations.geojson')
      .then(r => r.json())
      .then(geojson => {
        const markers = [];

        geojson.features?.forEach(f => {
          if (!f || f.geometry?.type !== 'Point') return;
          const [lng, lat] = f.geometry.coordinates || [];
          if (typeof lat !== 'number' || typeof lng !== 'number') return;

          // Optional per-feature color override: properties.color
          const icon = f.properties?.color
            ? L.divIcon({
                ...tentIcon.options,
                html: tentSVG.replace('class="tent-fill"', `class="tent-fill" style="fill:${cssEscape(f.properties.color)}"`),
              })
            : tentIcon;

          const m = L.marker([lat, lng], { icon })
            .bindPopup(getPopup(f));
          markers.push(m);
        });

        clusters.addLayers(markers);
        map.addLayer(clusters);

        // Fit to markers
        if (markers.length) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds(), { padding: [24,24], maxZoom: 12 });
        }
      })
      .catch(err => console.error('Failed to load GeoJSON:', err));

    // ---------- Helpers ----------
    function getPopup(f){
      const p = f.properties || {};
      const title = p.name || p.title || 'Location';
      const desc  = p.description || p.note || '';
      const extra = p.url ? `<br><a href="${escapeAttr(p.url)}" target="_blank" rel="noopener">More</a>` : '';
      return `<strong>${escapeHtml(title)}</strong>${desc ? `<br>${escapeHtml(desc)}` : ''}${extra}`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function escapeAttr(s){
      return String(s).replace(/"/g,'&quot;');
    }
    function cssEscape(s){
      // very light "sanitization" for inline style usage
      return String(s).replace(/[^#(),.%a-zA-Z0-9\- ]/g,'');
    }
  </script>
</body>
</html>


